# Лабораторная работа 2

## Настройка PS часть 1 и Hello World

## Обзор

В конце первой лабораторной работы мы в созданный Block Design при помощи IP Integrator добавили процессорную систему ARM. Когда мы дважды нажали на IP в Block Design, появилось средство кастомизации IP (Zynq Re-customize IP tool). В этой лабораторной работе мы продолжим настраивать нашу вычислительную подсистему, добавив туда периферию UART, настроив внутренний источник тактовых сигналов, и установив собственный контроллер памяти DDR. После окончания мы экспортируем нашу систему в SDK и создадим простое приложение Hello World.

## Цель работы

После выполнения лабораторной работы вы сможете:

* Включать и настраивать (мапить) периферию Zynq PS UART.
* Настраивать клоки и память для Zynq PS.
* Собирать аппаратную платформу.
* Экспортировать сбору в SDK.
* Создавать и запускать Hello_World-приложение.

## Эксперимент 1: Включение и настройка  периферии Zynq PS UART

Для начала включим периферию UART и сопоставим(смапим) ее входы/выходы к входам/выходам MIO.

---

### **Обобщенная инструкция:**

Установите напряжение банков LVCMOS 3.3V для Bank 0 и LVCMOS 1.8V для Bank 1. Включите UART1 и подключите ее входы/выходы к MIO[48:49].

---

### **Пошаговая инструкция:**

1. Если еще не открыто, открой созданный ранее проект *ZynqDesign* и откройте Block Design **Z_system.bd**. Дважды нажмите на *Zynq PS* для кастомизации PS. Окно *Zynq Block Design* демонстрирует, что в данный момент никакая периферия или интерфейс Flash-памяти не подключена. На это указывает тот факт, что на всей I/O периферии и Flash-памяти отсутствует галочка, как показно на рисунке ниже. Это также свидетельствует о MIO также ни к чему не подключен.

    ![периферия Zynq](./resources/lab2/Zynq%20IO%20Peripherials.png)

2. В боковой панели окна *Re-customize IP* выберите MIO Configuration и раскройте список **I/O Peripherials**.

    ![Конфигурация MIO](./resources/lab2/MIO%20Configuration.png)

3. В верху окна *MIO Configuration* находятся настройки напряжения банков. Установите *Bank 0 I/O Voltage* в значение **LVCMOS 3.3V** и *Bank 1 I/O Voltage* в значение **LVCMOS 1.8V**.

    ![Напряжение на банках MIO](./resources/lab2/MIO%20Bank%20Voltage.png)

    На данный момент никакая периферия не выбрана. Заметьте, что список периферий находится не в алфавитном порядке, а в порядке приоритетности в системе сверху вниз или как они насколько ограничено может быть их соединение с MIO. Периферия упорядочена как менее гибка вверху и более гибка внизу, за исключением USB, который может быть подключен только в одном месте.

    Во время работы с платой разработчик должен начать с верху, двигаясь вниз.Разработчик должен осторожно определить, какая периферия должна быть подключена к *MIO*, а какая к *EMIO*. Для упрощения эксперимента мы сфокусируемся только на одной периферии, чтобы показать как проходит весь процесс.

4. Для подключения доступны только два интерфейса *UART*. Установите чекбокс напротив **UART1**. Заметьте, что *UART1* может быть подключен к разным входам/выходам *MIO* и *EMIO* (Extended MIO). Установите значение *I/O* в **MIO48..49**, которое является значением по-умолчанию.

    ![Соединение UART1](./resources/lab2/UART1%20Connection.png)

5. В боковой панели *Page Navigator* выберите пункт **Zynq Block Design**. Заметьте, что в области *I/O Peripherals* напротив *UART 1* установлена галочка, что говорит о том, что эта периферия теперь подключена.

    ![UART1 соединен с MIO](./resources/lab2/UART1%20MIO%20Connected.png)

6. В окне с диаграммой *Zynq Block Design* нажмите на область **General Settings** или в боковой панели *Page Navigator* выберите пункт **PS-PL Configuration**.

    ![Общие настройки Zynq](./resources/lab2/General%20Zynq%20Settings.png)

7. Раскройте секцию *General* и удостоверьтесь, ято значение *Baud Rate* установлено в **115200**.

    ![Настройка Baud Rate UART1](./resources/lab2/UART1%20Baud%20Rate%20Settings.png)

---

### **Вопросы:**

* Как вы думаете, для чего нужен *EMIO*?

* Почему в *I/O Peripherals Configuration tool* периферия упорядочена не в алфавитном порядке?

* Вопрос со звездочкой: Если при включении периферии UART включить опцию *Modem Signal*, куда их следует соединить (смапить)?

## Эксперимент 2: Настройка памяти и клоков в Zynq PS

Перед запуском простейшей программы должны быть настроены еще пара критических элементов Zynq PS. В них входят DDR3-память, так как в этой памяти будет работать наше приложение. Также для нашей системы должны быть правильно сконфигурированы клоки.

### **Обобщенная инструкция:**

Настройте *Memory GUI* для 32 битного интерфейса, используя компоненты памяти Micron DDR3. Настройте клоки для работы CPU на частоте 667 МГц и память на 533 МГц.

### **Пошаговая инструкция:**

1. Нажмите на область **Clock Generation** на диаграмме или выберете пункт **Clock Generation** на боковой панели.

    ![Генерация клока](./resources/lab2/Clock%20Configuration.png)

2. Нажмите на кнопку **Expand All** на верхней навигационной панели, чтобы увидеть все тактовые сигналы.

    ![Развернуть все списки, чтобы увидеть все клоки](./resources/lab2/Expand%20to%20see%20all%20clocks.png)

3. Для большинства устройств значение частоты генератора импульсов соответствует настройкам платы *ZedBoard*. Удостоверьтесь, что значения следующие:

    * *Input frequency* - 33.33333 МГц
    * *CPU frequency* - 666.666666 МГц
    * *DDR frequency* - 533.333333 МГц

    ![Настройки клока](./resources/lab2/Clock%20Settings.png)

4. Сейчас нам требуется изменить значение настроек по-умолчанию. Один из *PL Fabric Clocks* включен, однако сейчас мы не используем PL. Выключите его, выставив соответствующий чекбокс в нужное положение.

    ![Выключите FCLK_CLK0](./resources/lab2/Disable%20FCLK_CLK0.png)

5. В добавок к отключению настроек *PL Fabric Clock* мы также должны отключить подключение AXI к PL. Это делает в *PS-PL Configuration*. Выберите пункт **PS-PL Configuration** и раскройте секцию **AXI Non Secure Enablement -> GP Master AXI Interface**. Отключите там **M AXI GP0 Interface** отключив чекбокс.

    ![Отключение M AXI GP0 Interface](./resources/lab2/Disable%20M%20AXI%20GP0%20Interface.png)

6. Теперь займемся контроллером памяти. На диаграмме выберите область **DDR2/3, LPDDR2 Controller** или в боковой навигационной области выберите пункт **DDR Configuration**.

    ![Конфигурация памяти DDR](./resources/lab2/DDR%20Memory%20Configuration.png)

7. Снова нажмите **Expand All**, чтобы увидеть все параметры памяти. Убедитесь, что чекбокс **Enable DDR** установлен.

    ![Параметры памяти и включение DDR](./resources/lab2/View%20Memory%20Parameters%20and%20Enable%20DDR.png)

8. Параметры, которые мы установим для DDR должны соответствовать плате, которую мы используем. Выставьте следующие параметры:
    
    * *Memory Type* - **DDR3**
    * *Memory Part* - **MT41J128M16 HA-15E**

    Обратите внимание на то, что настройки *Memory Part Configuration* автоматически обновятся при выборе *Memory Part*. Если ваше устройство памяти отсутствует в списке предустановленных, выберите **Custom**. Далее будут доступны поля для ручного ввода параметров вашей памяти.

    ![Параметры памяти](./resources/lab2/ZedBoard%20Memory%20Part%20Configuration.png)

9. В секции *DDR Controller Configuration* поле *Effective DRAM Bus Width* должно быть установлено **32-bits**, так как мы используем конфигурацию 2х16 DDR3. Так как мы используем DDR3 на устройствах 7z010 или 7z020 значение полей *ECC* и *Burst Length* предопределены. Обратите внимание, что частота работы автоматически была определена в окне *Clock Configuration* и равняется 533 МГц.

10. Установите чекбокс **Internal Vref**. Значение *Operating Temperature* должно быть **Normal (0-85)**.

    ![Параметры контроллера DDR](./resources/lab2/DDR%20Controller%20Configuration.png)

11. Далее настроим параметры *Training/Board Detail*. В секции *Dram Training* должны быть включены следующие 3 чекбоксы: *Write leveling*, *Read gate*, и *Read data eye*. Определение, что это такое можно найти в *Zynq TRM*, Параграф 10.6.8.

    ![Детали тренинга](./resources/lab2/Training%20Board%20Details.png)

    Обратите внимание, есть четыре поля ввода, позволяющие указать информацию о задержке *DQS* к *Clock Delay* (нс) и задержке *Board Delay* (нс) для каждой из четырех байтовых линий. Эти значения помогают алгоритму тренинга найти начальную точку в допустимом окне данных *DDR3*. По умолчанию все задержки равны 0.0. Учтите, что параметры для этих полей индивидуальны для каждой *PCB* и *Zynq package*.

    Значение основано на длине дорожек печатной платы и выбранном *Zynq package*.Vivado понимает, какой package был выбран, но пользователь должен указать значения для длины дорожек печатной платы.

    Как рассчитать эти длины, объясняется в Приложении. Если после завершения лабораторной работы у вас останется время, выполните предложенные там упражнения.

    Но в данный момент, чтобы сэкономить время, мы предоставим вам значения задержек.

12. Установите значения **DQS to Clock Delay** и **Board Delay** как показно на рисунке.

    ![значения для тренинга](./resources/lab2/ZedBoard%20Board%20Training%20Details.png)

13. Нажмите кнопку **OK** для окончания настройки Zynq PS.

14. Сохраните текущий *Block Design*.
